<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Analytic - Duite Bot</title>
  <meta name="description" content="DuÃ­te Bot - Dashboard analitik pengelolaan keuangan pribadi dengan integrasi Telegram & AI.">
  <meta name="keywords" content="duit bot, keuangan pribadi, dashboard telegram, catat pengeluaran, pencatatan transaksi">
  <meta property="og:title" content="Dashboard Analytic - Duite Bot">
  <meta property="og:description" content="Kelola pengeluaran dan pemasukan kamu lewat Telegram + AI & dashboard analitik.">
  <meta property="og:url" content="https://duite-bot.brogrammer.id">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://duite-bot.brogrammer.id/preview.png">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="icon" href="/favicon.ico" />
  <script src="./chart.js"></script>
  <script src="./tailwindcss.js"></script>
</head>
<body class="bg-gray-100 font-sans">

  <header class="bg-white shadow p-4">
    <!-- Top bar -->
    <div class="flex justify-between items-center">
      <!-- App Name (optional) -->
      <div class="text-sm font-semibold text-gray-700" id="navbarHeader">Halo Ikhsan, Selamat Datang di Duite Bot</div>
  
      <!-- Hamburger Button -->
      <button id="toggleFilterBtn" class="text-gray-600 hover:text-black focus:outline-none">
        <!-- Icon Hamburger -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
             viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>
  
    <!-- Filter Form (Hidden by default) -->
    <form id="filterForm" class="mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end hidden">
      <!-- Tanggal Mulai -->
      <div>
        <label for="startDate" class="block text-sm text-gray-600 mb-1">Dari</label>
        <input type="date" id="startDate" class="w-full p-2 border rounded-lg text-sm focus:ring-blue-500" />
      </div>
  
      <!-- Tanggal Selesai -->
      <div>
        <label for="endDate" class="block text-sm text-gray-600 mb-1">Sampai</label>
        <input type="date" id="endDate" class="w-full p-2 border rounded-lg text-sm focus:ring-blue-500" />
      </div>
  
      <!-- Kategori -->
      <div>
        <label for="category" class="block text-sm text-gray-600 mb-1">Kategori</label>
        <select id="category" class="w-full p-2 border rounded-lg text-sm focus:ring-blue-500">
          <option value="all">Semua</option>
          <option value="income">Pemasukan</option>
          <option value="expense">Pengeluaran</option>
        </select>
      </div>
  
      <!-- Tombol Terapkan -->
      <div>
        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg text-sm hover:bg-blue-700">
          Terapkan
        </button>
      </div>
    </form>
  </header>

  <main class="max-w-7xl mx-auto p-6 space-y-6">

    <!-- Summary Cards -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white rounded-lg shadow p-5">
        <h2 class="text-sm font-semibold text-gray-500 uppercase mb-2">Total Pemasukan</h2>
        <p class="text-3xl font-bold text-green-600" id="totalIncome">Rp 0</p>
      </div>
      <div class="bg-white rounded-lg shadow p-5">
        <h2 class="text-sm font-semibold text-gray-500 uppercase mb-2">Total Pengeluaran</h2>
        <p class="text-3xl font-bold text-red-600" id="totalExpense">Rp 0</p>
      </div>
    </section>

    <!-- Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Pie Chart -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-700">Distribusi Kategori Pengeluaran</h3>
        <canvas id="pieChart" class="w-full h-60"></canvas>
      </div>

      <!-- Line Chart -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-700">Pemasukan & Pengeluaran</h3>
        <canvas id="lineChart" class="w-full h-60"></canvas>
      </div>
    </section>

    <!-- Recent Transactions Table -->
    <section class="bg-white rounded-lg shadow p-4">
      <h3 class="text-sm font-semibold mb-3 text-gray-700">Transaksi Terakhir</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-left table-auto border-collapse text-sm">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="px-2 py-2 text-gray-500 font-medium">Jumlah (Rp)</th>
              <th class="px-2 py-2 text-gray-500 font-medium">Tanggal</th>
              <th class="px-2 py-2 text-gray-500 font-medium">Deskripsi</th>
              <th class="px-2 py-2 text-gray-500 font-medium">Kategori</th>
              <th class="px-2 py-2 text-gray-500 font-medium">Tipe</th>
            </tr>
          </thead>
          <tbody id="transactions-body">
            <!-- Data akan di-inject dari JavaScript -->
          </tbody>
        </table>
      </div>
    </section>

  </main>

  <script type="module">
    class Config {
      constructor() {
        this.baseUrl = 'https://duite-bot.brogrammer.id/api';
      }

      getUrl(endpoint) {
        return `${this.baseUrl}/${endpoint}`;
      }
    }

    class Transaction {
      constructor(config) {
        this.config = config;
        this.list = [];
        this.lineChart = null;
        this.pieChart = null;
        this.expenseTotal = 0;
        this.incomeTotal = 0;
        this.user = null
      }

      async setUser() {
        const storedChatId = localStorage.getItem("chatId");
        const params = new URLSearchParams(window.location.search);
        const chatId = decodeChatID(params.get('ref'));
        const randomPath = btoa(chatId + Date.now()).slice(0, 10); // encode & potong 10 karakter
        
        if (!storedChatId) {

          if (chatId) {
            localStorage.setItem("chatId", Number(chatId));

            const url = new URL(window.location);
            url.searchParams.set('ref', randomPath);
            window.history.replaceState({}, '', url);

            const user = await this.fetchUser(chatId);
            this.user = user;
          }
        } else {
          const url = new URL(window.location);
          url.searchParams.set('ref', randomPath);
          window.history.replaceState({}, '', url);

          const user = await this.fetchUser(storedChatId);
          this.user = user;
        }

        if (this.user) {
          document.getElementById("navbarHeader").innerText = `Halo ${this.user.name}, Selamat Datang di Duite Bot`
        } else {
          document.getElementById("navbarHeader").innerHTML = `
            Halo User, Silahkan join di
            <a href="https://t.me/duite_bot" target="_blank" class="text-blue-600 underline">Duite Bot</a>
          `;
        }
      }

      async fetchUser(chatId) {
        if (!chatId) {
          console.error('Chat ID not found');
          return;
        }

        try {
          const response = await fetch(this.config.getUrl(`users/${chatId}`));
          if (!response.ok) {
            throw new Error('Failed to fetch user');
          }
          const userData = await response.json();
          return userData;
        } catch (error) {
          console.error('Error fetching user:', error);
        }
      }

      async fetchAll() {
        if (! this.user) return
        
        try {
          const response = await fetch(this.config.getUrl('users/' + this.user.uuid + '/transactions'));
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          const transactions = data.transactions
          
          const expenseTotal = transactions
            .filter(trans => trans.transaction_type === 'EXPENSE')
            .reduce((sum, trans) => sum + Number(trans.amount), 0);

          const incomeTotal = transactions
            .filter(trans => trans.transaction_type === 'INCOME')
            .reduce((sum, trans) => sum + Number(trans.amount), 0);
          
          this.setChartData(data)
          this.setListTransactions(transactions)
          this.setExpenseTotal(expenseTotal)
          this.setIncomeTotal(incomeTotal)

          return transaction;
        } catch (error) {
          console.error('Error fetching transactions:', error);
          return [];
        }
      }

      render(transactions) {
        document.getElementById('totalExpense').innerText = 'Rp ' + this.expenseTotal.toLocaleString();
        document.getElementById('totalIncome').innerText = 'Rp ' + this.incomeTotal.toLocaleString();
        
        this.renderTableListTransaction(this.list)
      }

      renderTableListTransaction(data) {
        try {
          const tbody = document.getElementById("transactions-body");
          tbody.innerHTML = '';

          if (data.length == 0) {
            const row = `
              <tr class="border-b border-gray-100 hover:bg-gray-50 text-center">
                <td colspan="5" class="px-2 py-3 text-gray-500 italic">Tidak ada data</td>
              </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
            return
          }

          data.forEach(tx => {
            const isIncome = tx.transaction_type === 'INCOME' || tx.type === 'EXPENSE';
            const colorClass = isIncome ? 'text-green-600' : 'text-red-600';
            const typeText = isIncome ? 'Masuk' : 'Keluar';

            const row = `
              <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="px-2 py-2 ${colorClass} font-semibold">${Number(tx.amount).toLocaleString('id-ID')}</td>
                <td class="px-2 py-2">${formatDate(tx.transaction_date)}</td>
                <td class="px-2 py-2">${tx.original_text}</td>
                <td class="px-2 py-2">${formatCategorySlug(tx.category)}</td>
                <td class="px-2 py-2 ${colorClass} font-semibold">${typeText}</td>
              </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
          });
        } catch (err) {
          console.error("Gagal render transaksi:", err);
        }
      }

      setChartData(data) {
        this.lineChart = data.line
        this.pieChart = data.pie
      }

      setListTransactions(value) {
        this.list = value
      }

      setExpenseTotal(value) {
        this.expenseTotal = value
      }

      setIncomeTotal(value) {
        this.incomeTotal = value
      }
    }

    const config = new Config();
    const transaction = new Transaction(config);

    await transaction.setUser();
    transaction.fetchAll().then(data => {
      transaction.render(data);

      // Line Chart: Pemasukan & Pengeluaran Bulanan
      const defaultLabelLineChart = ['Pemasukan', 'Pengeluaran']
      const ctxLine = document.getElementById('lineChart').getContext('2d');
      const lineChart = new Chart(ctxLine, {
        type: 'line',
        data: {
          labels: transaction.lineChart?.labels ?? [],
          datasets: [
            {
              label: (transaction.lineChart) ? transaction.lineChart.datasets[0].label : [],
              data: (transaction.lineChart) ? transaction.lineChart.datasets[0].data : [],
              borderColor: 'rgba(34,197,94,1)', // green-500
              backgroundColor: 'rgba(34,197,94,0.2)',
              fill: true,
              tension: 0.3,
              pointRadius: 4,
            },
            {
              label: (transaction.lineChart) ? transaction.lineChart.datasets[1].label : [],
              data: (transaction.lineChart) ? transaction.lineChart.datasets[1].data : [],
              borderColor: 'rgba(239,68,68,1)', // red-500
              backgroundColor: 'rgba(239,68,68,0.2)',
              fill: true,
              tension: 0.3,
              pointRadius: 4,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { font: { size: 14 } } },
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'Rp ' + value.toLocaleString();
                }
              }
            }
          }
        },
      });
  
      // Pie Chart: Distribusi Pengeluaran
      const ctxPie = document.getElementById('pieChart').getContext('2d');

      const pieLabels = transaction.pieChart?.labels?.length
        ? transaction.pieChart.labels.map(item => formatCategorySlug(item))
        : ['Tidak ada data'];

      const pieData = transaction.pieChart?.data?.length
        ? transaction.pieChart.data
        : [1]; // Gunakan 1 agar tetap terlihat pie walau isinya "kosong"

      const pieChart = new Chart(ctxPie, {
        type: 'pie',
        data: {
          labels: pieLabels,
          datasets: [{
            label: 'Pengeluaran',
            data: pieData,
            backgroundColor: [
              'rgba(239,68,68,0.8)',  // red-600
              'rgba(220,38,38,0.8)',  // red-700
              'rgba(252,165,165,0.8)', // red-300
              'rgba(254,202,202,0.8)', // red-200
              'rgba(244,63,94,0.8)',   // red-500
            ],
            borderWidth: 1,
            borderColor: '#fff',
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'right',
              labels: { font: { size: 14 } }
            }
          }
        },
      });
    });

    function formatDate(isoString) {
      const date = new Date(isoString);
      const options = {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false,
      };
      return date.toLocaleString('id-ID', options).replace(',', '');
      return date
        .toLocaleString('id-ID', options)
        .replace(/\./g, ':') // ubah semua titik jadi titik dua
        .replace(',', '');
    }

    function formatCategorySlug(slug) {
      return slug
        .split('-')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }

    function decodeChatID(encoded) {
      const decodedStr = atob(encoded);
      return parseInt(decodedStr, 10);
    }

    // JavaScript toggle
    const toggleBtn = document.getElementById("toggleFilterBtn");
    const filterForm = document.getElementById("filterForm");
  
    toggleBtn.addEventListener("click", () => {
      filterForm.classList.toggle("hidden");
    });
  </script>

</body>
</html>
